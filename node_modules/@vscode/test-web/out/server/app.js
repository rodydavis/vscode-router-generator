"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
Object.defineProperty(exports, "__esModule", { value: true });
const Koa = require("koa");
const morgan = require("koa-morgan");
const kstatic = require("koa-static");
const kmount = require("koa-mount");
const workbench_1 = require("./workbench");
const path = require("path");
const mounts_1 = require("./mounts");
async function createApp(config) {
    const app = new Koa();
    if (!config.hideServerLog) {
        app.use(morgan('dev'));
    }
    // this is here such that the iframe worker can fetch the extension files
    app.use((ctx, next) => {
        ctx.set('Access-Control-Allow-Origin', '*');
        return next();
    });
    app.use(kmount('/static', kstatic(path.join(__dirname, '../static'))));
    if (config.extensionDevelopmentPath) {
        console.log('Serving dev extensions from ' + config.extensionDevelopmentPath);
        app.use(kmount('/static/devextensions', kstatic(config.extensionDevelopmentPath, { hidden: true })));
    }
    if (config.build.type === 'static') {
        app.use(kmount('/static/build', kstatic(config.build.location, { hidden: true })));
    }
    (0, mounts_1.configureMounts)(config, app);
    if (config.extensionPaths) {
        config.extensionPaths.forEach((extensionPath, index) => {
            console.log('Serving additional built-in extensions from ' + extensionPath);
            app.use(kmount(`/static/extensions/${index}`, kstatic(extensionPath, { hidden: true })));
        });
    }
    app.use((0, workbench_1.default)(config));
    return app;
}
exports.default = createApp;
